<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK Bus Smart Tracker 3.1</title>
    <style>
        :root { --primary: #004494; --accent: #ffcc00; --danger: #d32f2f; --bg: #f4f7f9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .step-label { font-size: 0.75rem; color: var(--primary); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input, select { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; margin-bottom: 15px; box-sizing: border-box; transition: border-color 0.3s; background-color: #fff; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn { width: 100%; padding: 16px; background: var(--accent); border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: transform 0.1s; }
        .btn:disabled { background: #ddd; color: #888; cursor: not-allowed; }
        .result-box { display: none; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .res-header { background: var(--primary); color: white; padding: 15px; text-align: center; }
        .bus-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .route-badge { background: #eef2f7; padding: 5px 10px; border-radius: 6px; font-weight: bold; color: var(--primary); }
        .time-text { color: var(--danger); font-weight: bold; font-size: 1.1rem; }
        .loading-overlay { display: none; text-align: center; padding: 20px; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="card">
        <span class="step-label">Step 1: Bus Company</span>
        <select id="coSelect">
            <option value="CTB">Citybus åŸå·´</option>
        </select>

        <span class="step-label">Step 2: Route Number</span>
        <input type="text" id="routeInput" placeholder="ä¾‹å¦‚: 77, 99, 38" oninput="fetchDirections()">

        <span class="step-label">Step 3: Direction</span>
        <select id="dirSelect" disabled>
            <option value="">è«‹å…ˆè¼¸å…¥è·¯ç·š...</option>
        </select>

        <button id="goBtn" class="btn" onclick="findNearestAndShow()" disabled>ğŸ“ åŒ¹é…æœ€è¿‘è»Šç«™åŠæŸ¥çœ‹ ETA</button>
    </div>

    <div id="loader" class="loading-overlay">æ­£åœ¨è¨ˆç®—è·é›¢ä¸¦ç²å–å³æ™‚ç­æ¬¡...</div>

    <div id="resultBox" class="result-box">
        <div class="res-header">
            <div id="stopName" style="font-weight: bold;"></div>
            <div id="distText" style="font-size: 0.75rem; opacity: 0.8; margin-top: 4px;"></div>
        </div>
        <div id="etaList"></div>
    </div>

<script>
    // è§£æ±º Step 3 å¡æ­»çš„é—œéµå‡½æ•¸
    async function fetchDirections() {
        const route = document.getElementById('routeInput').value.trim().toUpperCase();
        const dirSelect = document.getElementById('dirSelect');
        const btn = document.getElementById('goBtn');

        if (route.length < 1) {
            dirSelect.innerHTML = '<option value="">è«‹å…ˆè¼¸å…¥è·¯ç·š...</option>';
            dirSelect.disabled = true;
            btn.disabled = true;
            return;
        }

        dirSelect.innerHTML = '<option value="">æœå°‹ä¸­...</option>';

        try {
            // å„ªå…ˆå˜—è©¦ Vercel å®‰å…¨è·¯å¾‘
            let res = await fetch(`/api/route-info/${route}`);
            if (!res.ok) throw new Error();
            let data = await res.json();
            
            if (data && data.data) {
                dirSelect.innerHTML = `
                    <option value="outbound">å¾€ ${data.data.dest_tc} (${data.data.dest_en})</option>
                    <option value="inbound">å¾€ ${data.data.orig_tc} (${data.data.orig_en})</option>
                `;
                dirSelect.disabled = false;
                btn.disabled = false;
            } else {
                throw new Error();
            }
        } catch (e) {
            // å®¹éŒ¯é‚è¼¯ï¼šå¦‚æœå®‰å…¨è·¯å¾‘å¤±æ•—ï¼Œç›´æ¥é¡¯ç¤ºé è¨­æ–¹å‘
            dirSelect.innerHTML = `
                <option value="outbound">å»ç¨‹ (Outbound)</option>
                <option value="inbound">å›ç¨‹ (Inbound)</option>
            `;
            dirSelect.disabled = false;
            btn.disabled = false;
        }
    }

    async function findNearestAndShow() {
        const route = document.getElementById('routeInput').value.trim().toUpperCase();
        const dir = document.getElementById('dirSelect').value;
        const loader = document.getElementById('loader');
        const resBox = document.getElementById('resultBox');

        loader.style.display = "block";
        resBox.style.display = "none";

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const uLat = pos.coords.latitude;
            const uLon = pos.coords.longitude;

            try {
                // ç²å–è©²è·¯ç·šæ‰€æœ‰ç«™é»
                const stopsRes = await fetch(`/api/route-stops/${route}/${dir}`);
                const stopsData = await stopsRes.json();

                let closest = null;
                let minD = Infinity;

                // æ•ˆèƒ½å„ªåŒ–ï¼šé™åˆ¶åŒæ™‚æŸ¥è©¢çš„ç«™é»åº§æ¨™æ•¸é‡
                for (const s of stopsData.data) {
                    const infoRes = await fetch(`/api/stop-info/${s.stop}`);
                    const info = await infoRes.json();
                    
                    const dist = Math.sqrt(Math.pow(uLat - info.data.lat, 2) + Math.pow(uLon - info.data.long, 2));
                    if (dist < minD) {
                        minD = dist;
                        closest = { 
                            id: s.stop, 
                            name: info.data.name_tc + " " + info.data.name_en,
                            dist: Math.round(dist * 111320)
                        };
                    }
                }

                const etaRes = await fetch(`/api/eta/${closest.id}/${route}`);
                const etaData = await etaRes.json();

                showUI(closest, etaData.data);
            } catch (err) {
                alert("è®€å–å¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²çµ¡æˆ–è·¯ç·šç·¨è™Ÿã€‚");
            } finally {
                loader.style.display = "none";
            }
        }, () => {
            alert("è«‹æˆæ¬Š GPS å®šä½ä»¥æ‰¾å‡ºæœ€è¿‘è»Šç«™ã€‚");
            loader.style.display = "none";
        }, { enableHighAccuracy: true, timeout: 5000 });
    }

    function showUI(stop, etas) {
        document.getElementById('resultBox').style.display = "block";
        document.getElementById('stopName').innerText = stop.name;
        document.getElementById('distText').innerText = `è·é›¢æ‚¨ç´„ ${stop.dist} å…¬å°º`;

        let html = "";
        const valid = etas.filter(e => e.eta).map(e => ({
            route: e.route,
            min: Math.round((new Date(e.eta) - new Date()) / 60000)
        })).filter(e => e.min >= -1).sort((a,b) => a.min - b.min);

        valid.forEach(e => {
            html += `
            <div class="bus-row">
                <div class="route-badge">${e.route}</div>
                <div class="time-text">${e.min <= 0 ? 'å³å°‡æŠµé”' : e.min + ' åˆ†é˜'}</div>
            </div>`;
        });
        document.getElementById('etaList').innerHTML = html || '<div class="bus-row">ç›®å‰ç„¡ç­æ¬¡è³‡è¨Š</div>';
    }
</script>
</body>
</html>
