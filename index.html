<script>
    // 修正：使用 Vercel 的路徑來避開 CORS 阻擋
    async function updateDirections() {
        const route = document.getElementById('routeInput').value.trim().toUpperCase();
        const dirSelect = document.getElementById('dirSelect');
        const searchBtn = document.getElementById('searchBtn');

        if (route.length < 1) {
            dirSelect.innerHTML = '<option value="">請先輸入路線</option>';
            searchBtn.disabled = true;
            return;
        }

        try {
            // 修正點：改用內部 api 路徑，不要直接 call 外網
            const res = await fetch(`/api/route-info/${route}`);
            const data = await res.json();

            if (data && data.data) {
                const d = data.data;
                dirSelect.innerHTML = `
                    <option value="outbound">往 ${d.dest_tc} (Outbound)</option>
                    <option value="inbound">往 ${d.orig_tc} (Inbound)</option>
                `;
                searchBtn.disabled = false;
            } else {
                dirSelect.innerHTML = '<option value="">找不到路線資料</option>';
                searchBtn.disabled = true;
            }
        } catch (e) {
            dirSelect.innerHTML = '<option value="">路線讀取超時</option>';
        }
    }

    async function startSmartSearch() {
        const route = document.getElementById('routeInput').value.trim().toUpperCase();
        const dir = document.getElementById('dirSelect').value;
        const loader = document.getElementById('loader');
        
        if (!route || !dir) return;
        
        loader.style.display = "block";
        document.getElementById('resHeader').style.display = "none";
        document.getElementById('resBody').style.display = "none";

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const userLat = pos.coords.latitude;
            const userLon = pos.coords.longitude;

            try {
                const routeRes = await fetch(`/api/route-stops/${route}/${dir}`);
                const routeData = await routeRes.json();
                
                if(!routeData.data) throw new Error("Route error");

                let closestStop = null;
                let minDistance = Infinity;

                // 修正：限制同時發出的請求數量，避免卡死
                for (const s of routeData.data) {
                    const stopInfoRes = await fetch(`/api/stop-info/${s.stop}`);
                    const stopInfo = await stopInfoRes.json();
                    
                    const d = Math.sqrt(Math.pow(userLat - stopInfo.data.lat, 2) + Math.pow(userLon - stopInfo.data.long, 2));
                    if (d < minDistance) {
                        minDistance = d;
                        closestStop = { id: s.stop, name: stopInfo.data.name_tc + " " + stopInfo.data.name_en };
                    }
                }

                const etaRes = await fetch(`/api/eta/${closestStop.id}/${route}`);
                const etaData = await etaRes.json();

                displayResults(closestStop.name, etaData.data);
            } catch (e) {
                alert("搜尋失敗：請檢查網絡或路線編號。");
            } finally {
                loader.style.display = "none";
            }
        }, () => {
            alert("請開啟手機 GPS 權限後再試。");
            loader.style.display = "none";
        }, { enableHighAccuracy: true, timeout: 5000 });
    }

    function displayResults(stopName, data) {
        document.getElementById('resHeader').style.display = "block";
        document.getElementById('resBody').style.display = "block";
        document.getElementById('stopNameDisplay').innerText = stopName;

        let html = "";
        const arrivals = data.filter(b => b.eta).map(b => ({
            route: b.route,
            min: Math.round((new Date(b.eta) - new Date()) / 60000)
        })).filter(b => b.min >= -1).sort((a,b) => a.min - b.min);

        arrivals.forEach(b => {
            html += `
            <div class="bus-row">
                <div style="font-weight:bold; color:#004494;">Route ${b.route}</div>
                <div style="color:#d32f2f; font-weight:bold;">${b.min <= 0 ? '即將抵達' : b.min + ' 分鐘'}</div>
            </div>`;
        });
        document.getElementById('resBody').innerHTML = html || '<div class="bus-row" style="text-align:center">暫無即時班次</div>';
    }
</script>
