const STOPS = {
    WORK: { id: "002425", title: "業漁大廈 (全線)" },
    HOME: { id: "001217", title: "健康邨 (往銅鑼灣/中環)" }
};

async function fetchLiveBoard(stopId) {
    try {
        // We now call our OWN server path, which Vercel will redirect safely
        const res = await fetch(`/api/bus/${stopId}`);
        const json = await res.json();
        if (!json.data) return [];

        return json.data
            .filter(item => item.eta)
            .map(item => ({
                route: item.route,
                dest: item.dest_tc,
                diff: Math.round((new Date(item.eta) - new Date()) / 60000)
            }))
            .filter(item => item.diff >= -1)
            .sort((a, b) => a.diff - b.diff)
            .slice(0, 10);
    } catch (e) {
        return [];
    }
}

async function render(divId, stopId) {
    const container = document.getElementById(divId);
    const buses = await fetchLiveBoard(stopId);
    
    let html = "";
    buses.forEach(b => {
        html += `<div class="bus-row">
            <div class="route-id">${b.route}</div>
            <div class="dest-info">往 ${b.dest}</div>
            <div class="eta-time">${b.diff <= 0 ? "到站" : b.diff + "分"}</div>
        </div>`;
    });
    container.innerHTML = html || '<p style="text-align:center; padding:15px; color:#999;">目前無班次</p>';
}

function updateAll() {
    render('list-work', STOPS.WORK.id);
    render('list-home', STOPS.HOME.id);
    document.getElementById('update-status').innerText = "最後更新: " + new Date().toLocaleTimeString();
}

updateAll();
setInterval(updateAll, 30000);
