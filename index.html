<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK Bus GPS Tracker</title>
    <style>
        :root { --primary: #004494; --accent: #ffcc00; --danger: #d32f2f; --bg: #f2f4f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; box-sizing: border-box; outline: none; }
        .search-btn { width: 100%; padding: 15px; background: var(--accent); border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: opacity 0.2s; }
        .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .result-header { background: var(--primary); color: white; padding: 15px; border-radius: 12px 12px 0 0; text-align: center; margin-top: 20px; display: none; }
        .eta-card { background: white; border-radius: 0 0 12px 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        .bus-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; }
        .loading { text-align: center; padding: 20px; color: #888; display: none; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="card">
        <div class="input-group">
            <label>Route / è·¯ç·š</label>
            <input type="text" id="routeInput" placeholder="è¼¸å…¥è·¯ç·š (ä¾‹å¦‚ 77, 38)" oninput="updateDirections()">
        </div>
        <div class="input-group">
            <label>Direction / æ–¹å‘</label>
            <select id="dirSelect">
                <option value="">è«‹å…ˆè¼¸å…¥è·¯ç·š</option>
            </select>
        </div>
        <button id="searchBtn" class="search-btn" onclick="startSmartSearch()" disabled>ğŸ” æœå°‹æœ€è¿‘è»Šç«™åŠ ETA</button>
    </div>

    <div id="loader" class="loading">æ­£åœ¨å®šä½åŠæ¯”å°è»Šç«™...</div>

    <div id="resHeader" class="result-header">
        <h3 id="stopNameDisplay" style="margin:0; font-size:1rem;"></h3>
    </div>
    <div id="resBody" class="eta-card"></div>

<script>
    // å¯¦æ™‚ç²å–æ–¹å‘è³‡è¨Šï¼Œé¿å…å¡åœ¨ã€Œæœå°‹ä¸­ã€
    async function updateDirections() {
        const route = document.getElementById('routeInput').value.trim().toUpperCase();
        const dirSelect = document.getElementById('dirSelect');
        const searchBtn = document.getElementById('searchBtn');

        if (route.length < 1) {
            dirSelect.innerHTML = '<option value="">è«‹å…ˆè¼¸å…¥è·¯ç·š</option>';
            searchBtn.disabled = true;
            return;
        }

        try {
            // ä½¿ç”¨ Vercel ä»£ç†è·¯å¾‘
            const res = await fetch(`/api/route-info/${route}`);
            const data = await res.json();

            if (data && data.data) {
                const d = data.data;
                dirSelect.innerHTML = `
                    <option value="outbound">å¾€ ${d.dest_tc} (To ${d.dest_en})</option>
                    <option value="inbound">å¾€ ${d.orig_tc} (To ${d.orig_en})</option>
                `;
                searchBtn.disabled = false;
            } else {
                dirSelect.innerHTML = '<option value="">æ‰¾ä¸åˆ°è·¯ç·š</option>';
                searchBtn.disabled = true;
            }
        } catch (e) {
            dirSelect.innerHTML = '<option value="">æ­£åœ¨å˜—è©¦é€£ç·š...</option>';
        }
    }

    async function startSmartSearch() {
        const route = document.getElementById('routeInput').value.trim().toUpperCase();
        const dir = document.getElementById('dirSelect').value;
        const loader = document.getElementById('loader');
        
        loader.style.display = "block";
        document.getElementById('resHeader').style.display = "none";
        document.getElementById('resBody').style.display = "none";

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const userLat = pos.coords.latitude;
            const userLon = pos.coords.longitude;

            try {
                const routeRes = await fetch(`/api/route-stops/${route}/${dir}`);
                const routeData = await routeRes.json();
                
                if(!routeData.data) throw new Error("Route error");

                let closestStop = null;
                let minDistance = Infinity;

                // é€å€‹ç«™é»æ¯”å°è·é›¢
                for (const s of routeData.data) {
                    const stopInfoRes = await fetch(`/api/stop-info/${s.stop}`);
                    const stopInfo = await stopInfoRes.json();
                    
                    const d = Math.sqrt(Math.pow(userLat - stopInfo.data.lat, 2) + Math.pow(userLon - stopInfo.data.long, 2));
                    if (d < minDistance) {
                        minDistance = d;
                        closestStop = { id: s.stop, name: stopInfo.data.name_tc + " " + stopInfo.data.name_en };
                    }
                }

                const etaRes = await fetch(`/api/eta/${closestStop.id}/${route}`);
                const etaData = await etaRes.json();

                displayResults(closestStop.name, etaData.data);
            } catch (e) {
                alert("æ•¸æ“šè®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                loader.style.display = "none";
            }
        }, () => {
            alert("è«‹é–‹å•Ÿ GPS å®šä½æ¬Šé™ã€‚");
            loader.style.display = "none";
        });
    }

    function displayResults(stopName, data) {
        document.getElementById('resHeader').style.display = "block";
        document.getElementById('resBody').style.display = "block";
        document.getElementById('stopNameDisplay').innerText = stopName;

        let html = "";
        const arrivals = data.filter(b => b.eta).map(b => ({
            route: b.route,
            min: Math.round((new Date(b.eta) - new Date()) / 60000)
        })).filter(b => b.min >= -1).sort((a,b) => a.min - b.min);

        arrivals.forEach(b => {
            html += `
            <div class="bus-row">
                <div style="font-weight:bold; color:#004494;">Route ${b.route}</div>
                <div style="color:#d32f2f; font-weight:bold;">${b.min <= 0 ? 'åˆ°ç«™ä¸­' : b.min + ' åˆ†é˜'}</div>
            </div>`;
        });
        document.getElementById('resBody').innerHTML = html || '<div class="bus-row">æš«ç„¡ç­æ¬¡</div>';
    }
</script>
</body>
</html>
